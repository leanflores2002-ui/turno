<app-tabbed-shell
  title="Agenda del profesional"
  [subtitle]="doctorName() ? ('Bienvenido, ' + doctorName() + '.') : 'Gestioná tus turnos y fichas clínicas.'"
  [tabs]="tabs"
  [errorMessage]="appointmentsError() || availabilityError() || recordsError()"
>
  <div slot="actions">
    <button class="btn btn-secondary" type="button" (click)="refreshAppointments()" [disabled]="isLoadingAppointments()">
      {{ isLoadingAppointments() ? 'Actualizando…' : 'Actualizar turnos' }}
    </button>
  </div>

  <div slot="dashboard">
    <div class="doctor-dashboard">
      <div class="doctor-dashboard__stats">
        <div class="stat-card">
          <h3>Turnos Hoy</h3>
          <p class="stat-number">{{ sortedAppointments().length }}</p>
        </div>
        <div class="stat-card">
          <h3>Disponibilidad</h3>
          <p class="stat-number">{{ availability().length }}</p>
        </div>
        <div class="stat-card">
          <h3>Registros</h3>
          <p class="stat-number">{{ records().length }}</p>
        </div>
      </div>
      
      <div class="doctor-dashboard__recent">
        <h3>Próximos Turnos</h3>
        @if (isLoadingAppointments() && !sortedAppointments().length) {
          <p class="placeholder">Cargando turnos…</p>
        } @else if (!sortedAppointments().length) {
          <p class="placeholder">
            Todavía no tenés turnos asignados. Tus citas confirmadas aparecerán acá.
          </p>
        } @else {
          <ul class="appointments-list">
            @for (appointment of sortedAppointments().slice(0, 5); track appointment.id) {
              <li class="appointment-item">
                <div>
                  <h4>Paciente #{{ appointment.patient_id }}</h4>
                  <p>
                    {{ appointment.startAt | date: 'EEEE d MMMM' }} ·
                    {{ appointment.startAt | date: 'HH:mm' }} -
                    {{ appointment.endAt | date: 'HH:mm' }}
                  </p>
                </div>
                <span class="status" [ngClass]="appointment.status">
                  {{ appointment.status }}
                </span>
              </li>
            }
          </ul>
        }
      </div>
    </div>
  </div>

  <div slot="availability">
    <app-doctor-availability
      [availability]="availability()"
      [loading]="isLoadingAvailability()"
      [createPending]="isCreatingAvailability()"
      [mutationId]="availabilityMutationId()"
      [error]="availabilityError()"
      [message]="availabilityMessage()"
      [doctorName]="doctorName()"
      (refresh)="refreshAvailability()"
      (create)="onCreateAvailability($event)"
      (update)="onUpdateAvailability($event)"
    ></app-doctor-availability>
  </div>

  <div slot="appointments">
    <section class="appointments-section">
      <header class="appointments-header">
        <div>
          <h3>Turnos agendados</h3>
          <p>Visualizá tu agenda próxima.</p>
        </div>
      </header>

      @if (appointmentsError()) {
        <p class="error-message">{{ appointmentsError() }}</p>
      }

      @if (isLoadingAppointments() && !sortedAppointments().length) {
        <p class="placeholder">Cargando turnos…</p>
      } @else if (!sortedAppointments().length) {
        <p class="placeholder">
          Todavía no tenés turnos asignados. Tus citas confirmadas aparecerán acá.
        </p>
      } @else {
        <ul class="appointments-list">
          @for (appointment of sortedAppointments(); track appointment.id) {
            <li class="appointment-item">
              <div>
                <h4>Paciente #{{ appointment.patient_id }}</h4>
                <p>
                  {{ appointment.startAt | date: 'EEEE d MMMM' }} ·
                  {{ appointment.startAt | date: 'HH:mm' }} -
                  {{ appointment.endAt | date: 'HH:mm' }}
                </p>
              </div>
              <span class="status" [ngClass]="appointment.status">
                {{ appointment.status }}
              </span>
            </li>
          }
        </ul>
      }
    </section>
  </div>

  <div slot="records">
    <app-doctor-records
      [patients]="patients()"
      [records]="records()"
      [loadingPatients]="isLoadingPatients()"
      [loadingRecords]="isLoadingRecords()"
      [saving]="isSavingRecord()"
      [mutationId]="recordMutationId()"
      [error]="recordsError() || patientsError()"
      [message]="recordsMessage()"
      [doctorId]="doctorId"
      (refresh)="refreshRecords(); refreshPatients()"
      (updateRecord)="onUpdateRecord($event)"
    ></app-doctor-records>
  </div>
</app-tabbed-shell>
