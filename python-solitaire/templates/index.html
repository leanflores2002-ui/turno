<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solitario Klondike - Men√∫ Principal</title>
    <meta name="description" content="Juego de Solitario Klondike desarrollado en Python con Flask">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üé¥ Solitario Klondike</h1>
            <p class="subtitle">Proyecto Python - POO y CRUD</p>
        </header>

        <!-- Secci√≥n: Nueva Partida -->
        <section class="card">
            <h2>üÜï Nueva Partida</h2>
            <div class="form-group">
                <input 
                    type="text" 
                    id="nombrePartida" 
                    placeholder="Nombre de la partida (3-30 caracteres)"
                    maxlength="30"
                    class="input-field"
                >
                <button onclick="crearPartida()" class="btn btn-primary">
                    Crear y Jugar
                </button>
            </div>
        </section>

        <!-- Secci√≥n: Partidas Guardadas -->
        <section class="card">
            <h2>üìÅ Partidas Guardadas</h2>
            <button onclick="cargarListaPartidas()" class="btn btn-secondary">
                üîÑ Actualizar Lista
            </button>
            
            <div id="listaPartidas" class="partidas-lista">
                <p class="text-muted">Cargando partidas...</p>
            </div>
        </section>

        <!-- Secci√≥n: Estad√≠sticas -->
        <section class="card">
            <h2>üìä Estad√≠sticas Globales</h2>
            <div id="estadisticas" class="estadisticas">
                <p class="text-muted">Cargando estad√≠sticas...</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>
                Proyecto Acad√©mico - Python + Flask + HTML/CSS<br>
                Implementa: Clases Abstractas, Herencia, CRUD, M√≥dulos (json, deque, datetime, random, re)
            </p>
        </footer>
    </div>

    <script>
        // Cargar lista de partidas al inicio
        window.addEventListener('DOMContentLoaded', () => {
            cargarListaPartidas();
            cargarEstadisticas();
        });

        /**
         * Crea una nueva partida.
         */
        async function crearPartida() {
            const nombre = document.getElementById('nombrePartida').value.trim();
            
            if (!nombre) {
                alert('‚ùå Por favor ingresa un nombre para la partida');
                return;
            }

            try {
                const response = await fetch('/api/partidas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.mensaje}`);
                    window.location.href = '/juego';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        /**
         * Carga la lista de partidas guardadas.
         */
        async function cargarListaPartidas() {
            const contenedor = document.getElementById('listaPartidas');
            contenedor.innerHTML = '<p class="text-muted">Cargando...</p>';

            try {
                const response = await fetch('/api/partidas');
                const data = await response.json();

                if (data.success && data.partidas.length > 0) {
                    let html = '<div class="partidas-grid">';
                    
                    data.partidas.forEach(partida => {
                        html += `
                            <div class="partida-item">
                                <div class="partida-info">
                                    <h3>${partida.nombre}</h3>
                                    <p>üìÖ ${new Date(partida.fecha_creacion).toLocaleString('es-ES')}</p>
                                    <p>üéØ Progreso: ${partida.progreso}</p>
                                    <p>üî¢ Movimientos: ${partida.movimientos}</p>
                                </div>
                                <div class="partida-acciones">
                                    <button onclick="cargarPartida('${partida.nombre}')" class="btn btn-small btn-primary">
                                        ‚ñ∂Ô∏è Jugar
                                    </button>
                                    <button onclick="eliminarPartida('${partida.nombre}')" class="btn btn-small btn-danger">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    contenedor.innerHTML = html;
                } else {
                    contenedor.innerHTML = '<p class="text-muted">No hay partidas guardadas</p>';
                }
            } catch (error) {
                contenedor.innerHTML = `<p class="text-error">Error cargando partidas: ${error.message}</p>`;
            }
        }

        /**
         * Carga una partida existente.
         */
        async function cargarPartida(nombre) {
            try {
                const response = await fetch(`/api/partidas/${nombre}`);
                const data = await response.json();

                if (data.success) {
                    window.location.href = '/juego';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        /**
         * Elimina una partida.
         */
        async function eliminarPartida(nombre) {
            if (!confirm(`¬øEst√°s seguro de eliminar la partida "${nombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/partidas/${nombre}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.mensaje}`);
                    cargarListaPartidas();
                    cargarEstadisticas();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        /**
         * Carga las estad√≠sticas globales.
         */
        async function cargarEstadisticas() {
            const contenedor = document.getElementById('estadisticas');
            
            try {
                const response = await fetch('/api/estadisticas');
                const data = await response.json();

                if (data.success) {
                    const stats = data.estadisticas;
                    contenedor.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">Total Partidas:</span>
                                <span class="stat-value">${stats.total_partidas}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Partidas Ganadas:</span>
                                <span class="stat-value">${stats.partidas_ganadas}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Movimientos:</span>
                                <span class="stat-value">${stats.total_movimientos}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Promedio Movimientos:</span>
                                <span class="stat-value">${stats.promedio_movimientos ? stats.promedio_movimientos.toFixed(1) : 0}</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                contenedor.innerHTML = `<p class="text-error">Error cargando estad√≠sticas</p>`;
            }
        }
    </script>
</body>
</html>
